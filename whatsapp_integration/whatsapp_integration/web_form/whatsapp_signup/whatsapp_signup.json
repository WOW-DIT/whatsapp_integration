{
 "accept_payment": 0,
 "allow_comments": 0,
 "allow_delete": 0,
 "allow_edit": 0,
 "allow_incomplete": 0,
 "allow_multiple": 0,
 "allow_print": 0,
 "amount": 0.0,
 "amount_based_on_field": 0,
 "anonymous": 0,
 "apply_document_permissions": 0,
 "button_label": "Save",
 "client_script": "// Load Facebook SDK asynchronously\r\n(function (d, s, id) {\r\n  var js,\r\n    fjs = d.getElementsByTagName(s)[0];\r\n  if (d.getElementById(id)) return;\r\n  js = d.createElement(s);\r\n  js.id = id;\r\n  js.src = \"https://connect.facebook.net/en_US/sdk.js\";\r\n  fjs.parentNode.insertBefore(js, fjs);\r\n})(document, \"script\", \"facebook-jssdk\");\r\n\r\nwindow.fbAsyncInit = function () {\r\n  FB.init({\r\n    appId: \"1692370301463791\", // your app id\r\n    autoLogAppEvents: true,\r\n    xfbml: true,\r\n    version: \"v23.0\",\r\n  });\r\n};\r\n\r\nlet email = \"\";\r\nlet phone_id = \"\";\r\nlet business_id = \"\";\r\nlet business_name = \"\";\r\nlet code = \"\";\r\n\r\n// Handle messages from Embedded Signup iFrame\r\nwindow.addEventListener(\"message\", (event) => {\r\n  if (\r\n    event.origin !== \"https://www.facebook.com\" &&\r\n    event.origin !== \"https://web.facebook.com\"\r\n  ) {\r\n    return;\r\n  }\r\n  try {\r\n    const data = JSON.parse(event.data);\r\n    if (data.type === \"WA_EMBEDDED_SIGNUP\") {\r\n      if (data.event === \"FINISH\") {\r\n        const { phone_number_id, waba_id } = data.data;\r\n        phone_id = phone_number_id;\r\n        business_id = waba_id;\r\n      } else if (data.event === \"CANCEL\") {\r\n        const { current_step } = data.data;\r\n        console.warn(\"Cancel at \", current_step);\r\n      } else if (data.event === \"ERROR\") {\r\n        const { error_message } = data.data;\r\n        console.error(\"error \", error_message);\r\n      }\r\n    }\r\n    document.getElementById(\"session-info-response\").textContent =\r\n      JSON.stringify(data, null, 2);\r\n  } catch {\r\n    console.log(\"Non JSON Responses\", event.data);\r\n  }\r\n});\r\n  // Handle button click\r\n  document.getElementById(\"signup-btn\").addEventListener(\"click\", function () {\r\n    email = $('[data-fieldname=\"user\"] input').val();\r\n    business_name = $('[data-fieldname=\"business_name\"] input').val();\r\n \r\n    if (!email) {\r\n      frappe.msgprint(\"Please enter your email before signing up.\");\r\n      return;\r\n    }\r\n    \r\n    if (!business_name) {\r\n      frappe.msgprint(\"Please enter your business name before signing up.\");\r\n      return;\r\n    }\r\n\r\n    // Launch WhatsApp/Facebook Embedded Signup\r\n    FB.login(fbLoginCallback, {\r\n      config_id: \"1993600688075447\", // your config_id from Meta\r\n      response_type: \"code\",\r\n      override_default_response_type: true,\r\n      extras: {\r\n        version: \"v3\",\r\n        featureType: \"whatsapp_business_app_onboarding\",\r\n      },\r\n    });\r\n  });\r\n\r\n// Callback function after login/signup\r\nconst fbLoginCallback = (response) => {\r\n  if (response.authResponse) {\r\n    const code = response.authResponse.code;\r\n    const body = {\r\n        code: code,\r\n        phone_id: phone_id,\r\n        business_id: business_id,\r\n        business_name: business_name,\r\n        email: email,\r\n    }\r\n    console.log(body)\r\n    const url =\r\n      \"/api/method/whatsapp_integration.whatsapp_onboarding_api.init_instance\";\r\n    fetch(url, {\r\n      method: \"POST\",\r\n      credentials: \"include\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Accept\": \"application/json\",\r\n        \"X-Frappe-CSRF-Token\": (window.frappe && frappe.csrf_token) || \"\"\r\n      },\r\n      body: JSON.stringify(body)\r\n    })\r\n      .then((res) => {\r\n        if (!res.ok) {\r\n          throw new Error(`HTTP error! Status: ${res.status}`);\r\n        }\r\n        return res.json();\r\n      })\r\n      .then((data) => {\r\n        console.log(\"Server response:\", data);\r\n        if(!data.message.error) {\r\n            console.log(data)\r\n            frappe.msgprint(\"WhatsApp Instance is created successfully\");\r\n            const instance_id = data.message.instance_id;\r\n            location.href = `/app/whatsapp-instance/${instance_id}`;\r\n        }\r\n      })\r\n      .catch((err) => {\r\n        console.error(\"Fetch error:\", err);\r\n      });\r\n  }\r\n};",
 "condition_json": "[]",
 "creation": "2025-09-29 13:51:30.113173",
 "currency": "SAR",
 "custom_css": ".discard-btn, .submit-btn {\r\n    display: none !important;\r\n}",
 "doc_type": "WhatsApp Signup",
 "docstatus": 0,
 "doctype": "Web Form",
 "idx": 0,
 "is_standard": 1,
 "list_columns": [],
 "login_required": 1,
 "max_attachment_size": 0,
 "modified": "2025-10-01 16:35:58.098990",
 "modified_by": "Administrator",
 "module": "WhatsApp Integration",
 "name": "whatsapp-signup",
 "owner": "Administrator",
 "payment_button_label": "Buy Now",
 "published": 1,
 "route": "whatsapp-signup",
 "show_attachments": 0,
 "show_list": 0,
 "show_sidebar": 0,
 "title": "WhatsApp Signup",
 "web_form_fields": [
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "user",
   "fieldtype": "Link",
   "hidden": 0,
   "label": "Email",
   "max_length": 0,
   "max_value": 0,
   "options": "User",
   "precision": "",
   "read_only": 0,
   "reqd": 1,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "business_name",
   "fieldtype": "Data",
   "hidden": 0,
   "label": "Business Name",
   "max_length": 0,
   "max_value": 0,
   "precision": "",
   "read_only": 0,
   "reqd": 1,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldtype": "HTML",
   "hidden": 0,
   "label": "Signup",
   "max_length": 0,
   "max_value": 0,
   "options": "<button class=\"btn btn-primary\" id=\"signup-btn\" type=\"button\">Sign Up</button>",
   "precision": "",
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  }
 ]
}